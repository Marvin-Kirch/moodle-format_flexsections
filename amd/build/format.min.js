define("format_flexsections/format",["exports","core/notification","core/str","core/modal_factory","core/templates","core_courseformat/courseeditor","core/pending"],(function(_exports,_notification,_str,_modal_factory,_templates,_courseeditor,_pending){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Various actions on modules and sections in the editing mode - hiding, duplicating, deleting, etc.
   *
   * @module     format_flexsections/format
   * @copyright  2022 Marina Glancy
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_notification=_interopRequireDefault(_notification),_modal_factory=_interopRequireDefault(_modal_factory),_templates=_interopRequireDefault(_templates),_pending=_interopRequireDefault(_pending);const SELECTORS_SECTION_MERGEUP='li.section a[data-action-flexsections="mergeup"]',SELECTORS_SECTION_MOVE='li.section a[data-action-flexsections="move"]',SELECTORS_SECTIONLINK="[data-for='section']";_exports.init=()=>{(0,_courseeditor.getCurrentCourseEditor)().stateManager.addUpdateTypes({put:(stateManager,updateName,fields)=>{stateManager.defaultPut(stateManager,updateName,fields)}}),document.addEventListener("click",(e=>{const mergeupElement=e.target.closest(SELECTORS_SECTION_MERGEUP);if(mergeupElement)return e.preventDefault(),void confirmMerge(mergeupElement);const moveElement=e.target.closest(SELECTORS_SECTION_MOVE);return moveElement?(e.preventDefault(),void showMoveSectionPopup(moveElement)):void 0}))};const confirmMerge=target=>{const href=target.getAttribute("href");(0,_str.get_strings)([{key:"confirm",component:"moodle"},{key:"confirmmerge",component:"format_flexsections"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done((function(strings){_notification.default.confirm(strings[0],strings[1],strings[2],strings[3],(function(){window.location.href=href+"&confirm=1"}))})).fail(_notification.default.exception)},showMoveSectionPopup=target=>{const reactive=(0,_courseeditor.getCurrentCourseEditor)(),sectionId=target.getAttribute("data-id"),sectionInfo=reactive.get("section",sectionId),data=reactive.getExporter().course(reactive.state);data.sectiontitle=sectionInfo.title,console.log(data),1===data.sections.length&&"1"==="".concat(data.sections[0].singlesection)&&(data.singlesectionmode=1,data.sections[0].contentcollapsed=!1);const buildParents=(sections,parents)=>{for(var i in sections)sections[i].parents=parents,sections[i].aftersectionid=i>0?sections[i-1].id:0,buildParents(sections[i].children,parents+","+sections[i].id),sections[i].lastchildid=sections[i].children.length?sections[i].children[sections[i].children.length-1].id:0};buildParents(data.sections,""),data.lastchildid=data.sections.length?data.sections[data.sections.length-1].id:0,_modal_factory.default.create({type:_modal_factory.default.types.CANCEL,title:(0,_str.get_string)("movecoursesection","core"),large:!0,buttons:{cancel:(0,_str.get_string)("closebuttontitle","core")},removeOnClose:!0}).then((modal=>(_templates.default.render("format_flexsections/local/content/movesection",data).then((body=>{modal.setBody(body),setupMoveSection(reactive,modal,modal.getBody()[0],sectionId,data)})),modal.show(),modal)))},setupMoveSection=function(reactive,modal,modalBody,sectionId,data){let element=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;const links=modalBody.querySelectorAll("".concat(SELECTORS_SECTIONLINK));for(let i=0;i<links.length;++i){const re=new RegExp(",".concat(sectionId,","),"g");(links[i].getAttribute("data-id")==="".concat(sectionId)||links[i].getAttribute("data-after")==="".concat(sectionId)||"".concat(links[i].getAttribute("data-parents"),",").match(re))&&_disableLink(links[i])}modalBody.addEventListener("click",(event=>{const target=event.target;if(!target.matches("a")||"section"!==target.dataset.for||void 0===target.dataset.id)return;if(target.getAttribute("aria-disabled"))return;event.preventDefault(),reactive.dispatch("sectionMove",[sectionId],target.dataset.id),modal.hide();const pendingDestroy=new _pending.default("courseformat/actions:destroyModal");element&&element.focus(),setTimeout((()=>{modal.destroy(),pendingDestroy.resolve()}),500)}))},_disableLink=element=>{element&&(element.style.pointerEvents="none",element.style.userSelect="none",element.classList.add("disabled"),element.setAttribute("aria-disabled",!0),element.addEventListener("click",(event=>event.preventDefault())))}}));

//# sourceMappingURL=format.min.js.map