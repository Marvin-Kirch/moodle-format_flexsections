{"version":3,"file":"actions.min.js","sources":["../../../src/local/content/actions.js"],"sourcesContent":["/* eslint-disable no-console */\nimport {BaseComponent} from 'core/reactive';\nimport {get_string as getString, get_strings as getStrings} from \"core/str\";\nimport Notification from \"core/notification\";\nimport {getCurrentCourseEditor} from 'core_courseformat/courseeditor';\nimport ModalFactory from \"core/modal_factory\";\nimport Templates from \"core/templates\";\nimport Pending from \"core/pending\";\n\nexport default class extends BaseComponent {\n    // Example: course/format/amd/src/local/content/actions.js\n\n    /**\n     * Constructor hook.\n     */\n    create() {\n        // Optional component name for debugging.\n        // this.name = 'content_actions';\n        // Default query selectors.\n        this.selectors = {\n            ACTIONLINK: `[data-action-flexsections]`,\n            // // Move modal selectors.\n            SECTIONLINK: `[data-for='section']`,\n            // CMLINK: `[data-for='cm']`,\n            // SECTIONNODE: `[data-for='sectionnode']`,\n            // MODALTOGGLER: `[data-toggle='collapse']`,\n            // ADDSECTION: `[data-action='addSection']`,\n            // CONTENTTREE: `#destination-selector`,\n            // ACTIONMENU: `.action-menu`,\n            // ACTIONMENUTOGGLER: `[data-toggle=\"dropdown\"]`,\n        };\n        // Component css classes.\n        this.classes = {\n            DISABLED: `disabled`,\n        };\n    }\n\n    /**\n     * Initial state ready method.\n     *\n     * @param {Object} state the state data.\n     *\n     */\n    stateReady(state) {\n        super.stateReady(state);\n        // Delegate dispatch clicks.\n        this.addEventListener(\n            this.element,\n            'click',\n            this._dispatchClick\n        );\n    }\n\n    _dispatchClick(event) {\n        const target = event.target.closest(this.selectors.ACTIONLINK);\n        console.log('_dispatchClick');\n        console.log(event);\n        console.log(target);\n        if (!target) {\n            return;\n        }\n        if (target.classList.contains(this.classes.DISABLED)) {\n            event.preventDefault();\n            return;\n        }\n\n        // Invoke proper method.\n        const methodName = this._actionMethodName(target.getAttribute('data-action-flexsections'));\n        console.log('Trying to call '+methodName);\n\n        if (this[methodName] !== undefined) {\n            this[methodName](target, event);\n        }\n    }\n\n    _actionMethodName(name) {\n        const requestName = name.charAt(0).toUpperCase() + name.slice(1);\n        return `_request${requestName}`;\n    }\n\n    _requestMergeup(target, event) {\n        event.preventDefault();\n        const href = target.getAttribute('href');\n        getStrings([\n            {key: 'confirm', component: 'moodle'},\n            {key: 'confirmmerge', component: 'format_flexsections'},\n            {key: 'yes', component: 'moodle'},\n            {key: 'no', component: 'moodle'}\n        ]).done(function(strings) {\n            Notification.confirm(\n                strings[0], // Confirm.\n                strings[1], // Are you sure you want to merge.\n                strings[2], // Yes.\n                strings[3], // No.\n                function() {\n                    window.location.href = href + '&confirm=1';\n                }\n            );\n        }).fail(Notification.exception);\n    }\n\n    _requestMoveSection(target, event) {\n        event.preventDefault();\n        const reactive = getCurrentCourseEditor();\n        const sectionId = target.getAttribute('data-id');\n        const sectionInfo = reactive.get('section', sectionId);\n        const exporter = reactive.getExporter();\n        const data = exporter.course(reactive.state);\n        data.sectiontitle = sectionInfo.title;\n        //console.log(data);\n\n        if (data.sections.length === 1 && `${data.sections[0].singlesection}` === '1') {\n            // We are on a page of a collapsed section. Do not show \"move before\" and \"move after\" controls.\n            data.singlesectionmode = 1;\n            data.sections[0].contentcollapsed = false;\n            // TODO allow to move from collapsed section up level.\n        }\n        const buildParents = (sections, parents) => {\n            for (var i in sections) {\n                sections[i].parents = parents;\n                sections[i].aftersectionid = (i>0) ? sections[i-1].id : 0;\n                buildParents(sections[i].children, parents + ',' + sections[i].id);\n                sections[i].lastchildid = sections[i].children.length ?\n                    sections[i].children[sections[i].children.length - 1].id : 0;\n            }\n        };\n        buildParents(data.sections, '');\n        data.lastchildid = data.sections.length ? data.sections[data.sections.length - 1].id : 0;\n\n        ModalFactory.create({\n            type: ModalFactory.types.CANCEL,\n            title: getString('movecoursesection', 'core'),\n            large: true,\n            buttons: {cancel: getString('closebuttontitle', 'core')},\n            removeOnClose: true,\n        })\n            .then(modal => {\n                Templates.render('format_flexsections/local/content/movesection', data).\n                then((body) => {\n                    modal.setBody(body);\n                    this.setupMoveSection(reactive, modal, modal.getBody()[0], sectionId, data);\n                });\n                modal.show();\n                return modal;\n            });\n    }\n\n    _requestMoveCm(target, event) {\n        event.preventDefault();\n        const cmId = target.dataset.id;\n        if (!cmId) {\n            return;\n        }\n        const reactive = getCurrentCourseEditor();\n        const cmInfo = reactive.get('cm', cmId);\n\n        const exporter = reactive.getExporter();\n        const data = exporter.course(reactive.state);\n\n        // TODO set before and after current as disabled.\n        // TODO allow to move from collapsed section up level.\n\n        data.cmid = cmInfo.id;\n        data.cmname = cmInfo.name;\n\n        ModalFactory.create({\n            type: ModalFactory.types.CANCEL,\n            title: getString('movecoursemodule', 'core'),\n            large: true,\n            buttons: {cancel: getString('closebuttontitle', 'core')},\n            removeOnClose: true,\n        })\n            .then(modal => {\n                Templates.render('format_flexsections/local/content/movecm', data).\n                then((body) => {\n                    modal.setBody(body);\n                    this._setupMoveCm(reactive, modal, modal.getBody()[0], cmId, data);\n                });\n                modal.show();\n                return modal;\n            });\n    }\n\n    _setupMoveCm(reactive, modal, modalBody, cmId, data, element = null) {\n\n        // Capture click.\n        modalBody.addEventListener('click', (event) => {\n            const target = event.target;\n            if (!target.matches('a') || target.dataset.for === undefined || target.dataset.id === undefined) {\n                return;\n            }\n            if (target.getAttribute('aria-disabled')) {\n                return;\n            }\n            event.preventDefault();\n\n            const targetSectionId = (target.dataset.for === 'section') ? target.dataset.id : 0;\n            const targetCmId = (target.dataset.for === 'cm') ? target.dataset.id : 0;\n            reactive.dispatch('cmMove', [cmId], targetSectionId, targetCmId);\n            this._destroyModal(modal, element);\n        });\n    }\n\n    _destroyModal(modal, element = null) {\n\n        // Destroy\n        modal.hide();\n        const pendingDestroy = new Pending(`courseformat/actions:destroyModal`);\n        if (element) {\n            element.focus();\n        }\n        setTimeout(() =>{\n            modal.destroy();\n            pendingDestroy.resolve();\n        }, 500);\n\n    }\n\n    setupMoveSection(reactive, modal, modalBody, sectionId, data, element = null) {\n\n        // Disable moving before or after itself or under one of its own children.\n        const links = modalBody.querySelectorAll(`${this.selectors.SECTIONLINK}`);\n        for (let i = 0; i < links.length; ++i) {\n            const re = new RegExp(`,${sectionId},`,\"g\");\n            if (links[i].getAttribute('data-before') === `${sectionId}` || links[i].getAttribute('data-after') === `${sectionId}` ||\n                `${links[i].getAttribute('data-parents')},`.match(re)) {\n                this._disableLink(links[i]);\n            }\n        }\n\n        // Setup keyboard navigation.\n        // new ContentTree(\n        //     modalBody.querySelector(this.selectors.CONTENTTREE),\n        //     {\n        //         SECTION: this.selectors.SECTIONNODE,\n        //         TOGGLER: this.selectors.MODALTOGGLER,\n        //         COLLAPSE: this.selectors.MODALTOGGLER,\n        //     },\n        //     true\n        // );\n\n        // Capture click.\n        modalBody.addEventListener('click', (event) => {\n\n            const target = event.target;\n            if (!target.matches('a') || target.dataset.for !== 'section' || target.dataset.after === undefined) {\n                return;\n            }\n            if (target.getAttribute('aria-disabled')) {\n                return;\n            }\n            event.preventDefault();\n            const afterId = parseInt(target.dataset.after);\n            const parentId = parseInt(target.dataset.parent);\n            reactive.dispatch('sectionMove', [sectionId], afterId ? afterId : -parentId);\n\n            this._destroyModal(modal, element);\n        });\n    }\n\n    /**\n     * Disable link\n     *\n     * @param {Element} element\n     */\n    _disableLink(element) {\n        if (element) {\n            element.style.pointerEvents = 'none';\n            element.style.userSelect = 'none';\n            element.classList.add('disabled');\n            element.setAttribute('aria-disabled', true);\n            element.addEventListener('click', event => event.preventDefault());\n        }\n    }\n\n}\n"],"names":["BaseComponent","create","selectors","ACTIONLINK","SECTIONLINK","classes","DISABLED","stateReady","state","addEventListener","this","element","_dispatchClick","event","target","closest","console","log","classList","contains","preventDefault","methodName","_actionMethodName","getAttribute","undefined","name","requestName","charAt","toUpperCase","slice","_requestMergeup","href","key","component","done","strings","confirm","window","location","fail","Notification","exception","_requestMoveSection","reactive","sectionId","sectionInfo","get","data","getExporter","course","sectiontitle","title","sections","length","singlesection","singlesectionmode","contentcollapsed","buildParents","parents","i","aftersectionid","id","children","lastchildid","type","ModalFactory","types","CANCEL","large","buttons","cancel","removeOnClose","then","modal","render","body","setBody","setupMoveSection","getBody","show","_requestMoveCm","cmId","dataset","cmInfo","cmid","cmname","_setupMoveCm","modalBody","matches","for","targetSectionId","targetCmId","dispatch","_destroyModal","hide","pendingDestroy","Pending","focus","setTimeout","destroy","resolve","links","querySelectorAll","re","RegExp","match","_disableLink","after","afterId","parseInt","parentId","parent","style","pointerEvents","userSelect","add","setAttribute"],"mappings":"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"}