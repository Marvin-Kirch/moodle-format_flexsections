{"version":3,"file":"format.min.js","sources":["../src/format.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Various actions on modules and sections in the editing mode - hiding, duplicating, deleting, etc.\n *\n * @module     format_flexsections/format\n * @copyright  2022 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport ModalFactory from \"core/modal_factory\";\n//import Fragment from \"core/fragment\";\nimport Templates from \"core/templates\";\nimport {getCurrentCourseEditor} from 'core_courseformat/courseeditor';\n//import ContentTree from \"../../../amd/src/local/courseeditor/contenttree\";\nimport Pending from \"core/pending\";\n\nconst SELECTORS = {\n    SECTION_MERGEUP: 'li.section a[data-action-flexsections=\"mergeup\"]',\n    SECTION_MOVE: 'li.section a[data-action-flexsections=\"move\"]',\n    SECTIONLINK: `[data-for='section']`,\n};\n\n/**\n * Initialize module\n */\nexport const init = () => {\n    document.addEventListener('click', e => {\n        const mergeupElement = e.target.closest(SELECTORS.SECTION_MERGEUP);\n        if (mergeupElement) {\n            e.preventDefault();\n            confirmMerge(mergeupElement);\n            return;\n        }\n\n        const moveElement = e.target.closest(SELECTORS.SECTION_MOVE);\n        if (moveElement) {\n            e.preventDefault();\n            moveSection(moveElement);\n            return;\n        }\n    });\n};\n\nconst confirmMerge = (target) => {\n    const href = target.getAttribute('href');\n    getStrings([\n        {key: 'confirm', component: 'moodle'},\n        {key: 'confirmmerge', component: 'format_flexsections'},\n        {key: 'yes', component: 'moodle'},\n        {key: 'no', component: 'moodle'}\n    ]).done(function(strings) {\n        Notification.confirm(\n            strings[0], // Confirm.\n            strings[1], // Are you sure you want to merge.\n            strings[2], // Yes.\n            strings[3], // No.\n            function() {\n                window.location.href = href + '&confirm=1';\n            }\n        );\n    }).fail(Notification.exception);\n};\n\nconst moveSection = (target) => {\n    /* eslint-disable no-console */\n    console.log(target);\n    console.log(target.getAttribute('data-ctxid'));\n    const reactive = getCurrentCourseEditor();\n    console.log(reactive);\n    const sectionId = target.getAttribute('data-id');\n    const sectionInfo = reactive.get('section', sectionId);\n    console.log(sectionInfo);\n    const exporter = reactive.getExporter();\n    const data = exporter.course(reactive.state);\n    console.log(data);\n    ModalFactory.create({\n        type: ModalFactory.types.CANCEL,\n        title: getString('movecoursesection', 'core'),\n        //body: Templates.render('format_flexsections/local/content/movesection', data),\n        large: true,\n        buttons: {cancel: getString('closebuttontitle', 'core')},\n        removeOnClose: true,\n    })\n        .then(modal => {\n            // Fragment.loadFragment('format_flexsections', 'section_move_target', target.getAttribute('data-ctxid'),\n            //         {sid: sectionId}).done((html, js) => {\n            //     modal.setBody(html);\n            //     Templates.runTemplateJS(js);\n            // });\n            Templates.render('format_flexsections/local/content/movesection', data).\n                then((body) => {\n                    modal.setBody(body);\n                    setupMoveSection(reactive, modal, modal.getBody()[0], sectionId);\n            });\n            modal.show();\n            return modal;\n        });\n};\n\nconst setupMoveSection = (reactive, modal, modalBody, sectionId, element = null) => {\n    // Disable current element and section zero.\n    // const currentElement = modalBody.querySelector(`${SELECTORS.SECTIONLINK}[data-id='${sectionId}']`);\n    // _disableLink(currentElement);\n    // const generalSection = modalBody.querySelector(`${SELECTORS.SECTIONLINK}[data-number='0']`);\n    // _disableLink(generalSection);\n\n    // Setup keyboard navigation.\n    // new ContentTree(\n    //     modalBody.querySelector(this.selectors.CONTENTTREE),\n    //     {\n    //         SECTION: this.selectors.SECTIONNODE,\n    //         TOGGLER: this.selectors.MODALTOGGLER,\n    //         COLLAPSE: this.selectors.MODALTOGGLER,\n    //     },\n    //     true\n    // );\n\n    // Capture click.\n    modalBody.addEventListener('click', (event) => {\n\n        const target = event.target;\n        if (!target.matches('a') || target.dataset.for !== 'section' || target.dataset.id === undefined) {\n            return;\n        }\n        if (target.getAttribute('aria-disabled')) {\n            return;\n        }\n        event.preventDefault();\n        reactive.dispatch('sectionMove', [sectionId], target.dataset.id);\n\n        // Destroy\n        modal.hide();\n        const pendingDestroy = new Pending(`courseformat/actions:destroyModal`);\n        if (element) {\n            element.focus();\n        }\n        setTimeout(() =>{\n            modal.destroy();\n            pendingDestroy.resolve();\n        }, 500);\n    });\n};\n\n/**\n * Replace an element with a copy with a different tag name.\n *\n * @param {Element} element the original element\n */\n// const _disableLink = (element) => {\n//     console.log('...trying to disable '+element.getAttribute('data-id'));\n//     if (element) {\n//         element.style.pointerEvents = 'none';\n//         element.style.userSelect = 'none';\n//         element.classList.add('disabled');\n//         element.setAttribute('aria-disabled', true);\n//         element.addEventListener('click', event => event.preventDefault());\n//     }\n// };\n"],"names":["SELECTORS","document","addEventListener","e","mergeupElement","target","closest","preventDefault","confirmMerge","moveElement","moveSection","href","getAttribute","key","component","done","strings","confirm","window","location","fail","Notification","exception","console","log","reactive","sectionId","sectionInfo","get","data","getExporter","course","state","create","type","ModalFactory","types","CANCEL","title","large","buttons","cancel","removeOnClose","then","modal","render","body","setBody","setupMoveSection","getBody","show","modalBody","element","event","matches","dataset","for","undefined","id","dispatch","hide","pendingDestroy","Pending","focus","setTimeout","destroy","resolve"],"mappings":";;;;;;;0RAgCMA,0BACe,mDADfA,uBAEY,8DAOE,KAChBC,SAASC,iBAAiB,SAASC,UACzBC,eAAiBD,EAAEE,OAAOC,QAAQN,8BACpCI,sBACAD,EAAEI,sBACFC,aAAaJ,sBAIXK,YAAcN,EAAEE,OAAOC,QAAQN,+BACjCS,aACAN,EAAEI,sBACFG,YAAYD,+BAMlBD,aAAgBH,eACZM,KAAON,OAAOO,aAAa,6BACtB,CACP,CAACC,IAAK,UAAWC,UAAW,UAC5B,CAACD,IAAK,eAAgBC,UAAW,uBACjC,CAACD,IAAK,MAAOC,UAAW,UACxB,CAACD,IAAK,KAAMC,UAAW,YACxBC,MAAK,SAASC,+BACAC,QACTD,QAAQ,GACRA,QAAQ,GACRA,QAAQ,GACRA,QAAQ,IACR,WACIE,OAAOC,SAASR,KAAOA,KAAO,mBAGvCS,KAAKC,sBAAaC,YAGnBZ,YAAeL,SAEjBkB,QAAQC,IAAInB,QACZkB,QAAQC,IAAInB,OAAOO,aAAa,qBAC1Ba,UAAW,0CACjBF,QAAQC,IAAIC,gBACNC,UAAYrB,OAAOO,aAAa,WAChCe,YAAcF,SAASG,IAAI,UAAWF,WAC5CH,QAAQC,IAAIG,mBAENE,KADWJ,SAASK,cACJC,OAAON,SAASO,OACtCT,QAAQC,IAAIK,6BACCI,OAAO,CAChBC,KAAMC,uBAAaC,MAAMC,OACzBC,OAAO,mBAAU,oBAAqB,QAEtCC,OAAO,EACPC,QAAS,CAACC,QAAQ,mBAAU,mBAAoB,SAChDC,eAAe,IAEdC,MAAKC,2BAMQC,OAAO,gDAAiDhB,MAC9Dc,MAAMG,OACFF,MAAMG,QAAQD,MACdE,iBAAiBvB,SAAUmB,MAAOA,MAAMK,UAAU,GAAIvB,cAE9DkB,MAAMM,OACCN,UAIbI,iBAAmB,SAACvB,SAAUmB,MAAOO,UAAWzB,eAAW0B,+DAAU,KAmBvED,UAAUjD,iBAAiB,SAAUmD,cAE3BhD,OAASgD,MAAMhD,WAChBA,OAAOiD,QAAQ,MAA+B,YAAvBjD,OAAOkD,QAAQC,UAA2CC,IAAtBpD,OAAOkD,QAAQG,aAG3ErD,OAAOO,aAAa,wBAGxByC,MAAM9C,iBACNkB,SAASkC,SAAS,cAAe,CAACjC,WAAYrB,OAAOkD,QAAQG,IAG7Dd,MAAMgB,aACAC,eAAiB,IAAIC,sDACvBV,SACAA,QAAQW,QAEZC,YAAW,KACPpB,MAAMqB,UACNJ,eAAeK,YAChB"}