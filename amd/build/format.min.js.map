{"version":3,"file":"format.min.js","sources":["../src/format.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Various actions on modules and sections in the editing mode - hiding, duplicating, deleting, etc.\n *\n * @module     format_flexsections/format\n * @copyright  2022 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport ModalFactory from \"core/modal_factory\";\n//import Fragment from \"core/fragment\";\nimport Templates from \"core/templates\";\nimport {getCurrentCourseEditor} from 'core_courseformat/courseeditor';\n//import ContentTree from \"../../../amd/src/local/courseeditor/contenttree\";\nimport Pending from \"core/pending\";\n//import DefaultMutations from 'core_courseformat/local/courseeditor/mutations';\n//import DefaultStateManager from 'core/local/reactive/stateManager';\n//import {Reactive} from \"core/reactive\";\n\n/* eslint-disable no-console */\n\nconst SELECTORS = {\n    SECTION_MERGEUP: 'li.section a[data-action-flexsections=\"mergeup\"]',\n    SECTION_MOVE: 'li.section a[data-action-flexsections=\"move\"]',\n    SECTIONLINK: `[data-for='section']`,\n};\n\n/**\n * Initialize module\n */\nexport const init = () => {\n    const reactive = getCurrentCourseEditor();\n    //reactive.stateManager = new FlexsectionsStateManager(reactive.eventDispatch, reactive.target);\n    const myput = (stateManager, updateName, fields) => {\n        //console.log('__myput__ '+updateName);\n        //console.log(stateManager);\n        //console.log(fields);\n        stateManager.defaultPut(stateManager, updateName, fields);\n    };\n    reactive.stateManager.addUpdateTypes({\"put\": myput});\n\n    document.addEventListener('click', e => {\n        const mergeupElement = e.target.closest(SELECTORS.SECTION_MERGEUP);\n        if (mergeupElement) {\n            e.preventDefault();\n            confirmMerge(mergeupElement);\n            return;\n        }\n\n        const moveElement = e.target.closest(SELECTORS.SECTION_MOVE);\n        if (moveElement) {\n            e.preventDefault();\n            showMoveSectionPopup(moveElement);\n            return;\n        }\n    });\n};\n\nconst confirmMerge = (target) => {\n    const href = target.getAttribute('href');\n    getStrings([\n        {key: 'confirm', component: 'moodle'},\n        {key: 'confirmmerge', component: 'format_flexsections'},\n        {key: 'yes', component: 'moodle'},\n        {key: 'no', component: 'moodle'}\n    ]).done(function(strings) {\n        Notification.confirm(\n            strings[0], // Confirm.\n            strings[1], // Are you sure you want to merge.\n            strings[2], // Yes.\n            strings[3], // No.\n            function() {\n                window.location.href = href + '&confirm=1';\n            }\n        );\n    }).fail(Notification.exception);\n};\n\nconst showMoveSectionPopup = (target) => {\n    const reactive = getCurrentCourseEditor();\n    const sectionId = target.getAttribute('data-id');\n    const sectionInfo = reactive.get('section', sectionId);\n    const exporter = reactive.getExporter();\n    const data = exporter.course(reactive.state);\n    data.sectiontitle = sectionInfo.title;\n    //console.log(data);\n\n    if (data.sections.length === 1 && `${data.sections[0].singlesection}` === '1') {\n        // We are on a page of a collapsed section. Do not show \"move before\" and \"move after\" controls.\n        data.singlesectionmode = 1;\n        data.sections[0].contentcollapsed = false;\n    }\n    const buildParents = (sections, parents) => {\n        for (var i in sections) {\n            sections[i].parents = parents;\n            sections[i].aftersectionid = (i>0) ? sections[i-1].id : 0;\n            buildParents(sections[i].children, parents + ',' + sections[i].id);\n            sections[i].lastchildid = sections[i].children.length ? sections[i].children[sections[i].children.length - 1].id : 0;\n        }\n    };\n    buildParents(data.sections, '');\n    data.lastchildid = data.sections.length ? data.sections[data.sections.length - 1].id : 0;\n\n    ModalFactory.create({\n        type: ModalFactory.types.CANCEL,\n        title: getString('movecoursesection', 'core'),\n        large: true,\n        buttons: {cancel: getString('closebuttontitle', 'core')},\n        removeOnClose: true,\n    })\n        .then(modal => {\n            Templates.render('format_flexsections/local/content/movesection', data).\n                then((body) => {\n                    modal.setBody(body);\n                    setupMoveSection(reactive, modal, modal.getBody()[0], sectionId, data);\n            });\n            modal.show();\n            return modal;\n        });\n};\n\nconst setupMoveSection = (reactive, modal, modalBody, sectionId, data, element = null) => {\n\n    // Disable moving before or after itself or under one of its own children.\n    const links = modalBody.querySelectorAll(`${SELECTORS.SECTIONLINK}`);\n    for (let i = 0; i < links.length; ++i) {\n        const re = new RegExp(`,${sectionId},`,\"g\");\n        if (links[i].getAttribute('data-id') === `${sectionId}` || links[i].getAttribute('data-after') === `${sectionId}` ||\n            `${links[i].getAttribute('data-parents')},`.match(re)) {\n            _disableLink(links[i]);\n        }\n    }\n\n    // Setup keyboard navigation.\n    // new ContentTree(\n    //     modalBody.querySelector(this.selectors.CONTENTTREE),\n    //     {\n    //         SECTION: this.selectors.SECTIONNODE,\n    //         TOGGLER: this.selectors.MODALTOGGLER,\n    //         COLLAPSE: this.selectors.MODALTOGGLER,\n    //     },\n    //     true\n    // );\n\n    // Capture click.\n    modalBody.addEventListener('click', (event) => {\n\n        const target = event.target;\n        if (!target.matches('a') || target.dataset.for !== 'section' || target.dataset.id === undefined) {\n            return;\n        }\n        if (target.getAttribute('aria-disabled')) {\n            return;\n        }\n        event.preventDefault();\n        reactive.dispatch('sectionMove', [sectionId], target.dataset.id);\n\n        // Destroy\n        modal.hide();\n        const pendingDestroy = new Pending(`courseformat/actions:destroyModal`);\n        if (element) {\n            element.focus();\n        }\n        setTimeout(() =>{\n            modal.destroy();\n            pendingDestroy.resolve();\n        }, 500);\n    });\n};\n\n/**\n * Disable link\n *\n * @param {Element} element\n */\nconst _disableLink = (element) => {\n    if (element) {\n        element.style.pointerEvents = 'none';\n        element.style.userSelect = 'none';\n        element.classList.add('disabled');\n        element.setAttribute('aria-disabled', true);\n        element.addEventListener('click', event => event.preventDefault());\n    }\n};\n"],"names":["SELECTORS","stateManager","addUpdateTypes","updateName","fields","defaultPut","document","addEventListener","e","mergeupElement","target","closest","preventDefault","confirmMerge","moveElement","showMoveSectionPopup","href","getAttribute","key","component","done","strings","confirm","window","location","fail","Notification","exception","reactive","sectionId","sectionInfo","get","data","getExporter","course","state","sectiontitle","title","sections","length","singlesection","singlesectionmode","contentcollapsed","buildParents","parents","i","aftersectionid","id","children","lastchildid","create","type","ModalFactory","types","CANCEL","large","buttons","cancel","removeOnClose","then","modal","render","body","setBody","setupMoveSection","getBody","show","modalBody","element","links","querySelectorAll","re","RegExp","match","_disableLink","event","matches","dataset","for","undefined","dispatch","hide","pendingDestroy","Pending","focus","setTimeout","destroy","resolve","style","pointerEvents","userSelect","classList","add","setAttribute"],"mappings":"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"}