{"version":3,"file":"format.min.js","sources":["../src/format.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Various actions on modules and sections in the editing mode - hiding, duplicating, deleting, etc.\n *\n * @module     format_flexsections/format\n * @copyright  2022 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport ModalFactory from \"core/modal_factory\";\n//import Fragment from \"core/fragment\";\nimport Templates from \"core/templates\";\nimport {getCurrentCourseEditor} from 'core_courseformat/courseeditor';\n//import ContentTree from \"../../../amd/src/local/courseeditor/contenttree\";\nimport Pending from \"core/pending\";\n//import DefaultMutations from 'core_courseformat/local/courseeditor/mutations';\n//import DefaultStateManager from 'core/local/reactive/stateManager';\n//import {Reactive} from \"core/reactive\";\nimport Exporter from \"format_flexsections/local/courseeditor/exporter\";\n/* eslint-disable no-console */\n\nconst SELECTORS = {\n    SECTION_MERGEUP: 'li.section a[data-action-flexsections=\"mergeup\"]',\n    SECTION_MOVE: 'li.section a[data-action-flexsections=\"moveSection\"]',\n    CM_MOVE: 'li.section a[data-action-flexsections=\"moveCm\"]',\n    SECTIONLINK: `[data-for='section']`,\n};\n\n/**\n * Initialize module\n */\nexport const init = () => {\n\n    // Experiment - overriding \"put\" method.\n    // const reactive = getCurrentCourseEditor();\n    // const myput = (stateManager, updateName, fields) => {\n    //     stateManager.defaultPut(stateManager, updateName, fields);\n    // };\n    // reactive.stateManager.addUpdateTypes({\"put\": myput});\n\n    // Override exporter.\n    const reactive = getCurrentCourseEditor();\n    reactive.getExporter = () => new Exporter(reactive);\n\n    document.addEventListener('click', e => {\n        const mergeupElement = e.target.closest(SELECTORS.SECTION_MERGEUP);\n        if (mergeupElement) {\n            e.preventDefault();\n            confirmMerge(mergeupElement);\n            return;\n        }\n\n        const moveElement = e.target.closest(SELECTORS.SECTION_MOVE);\n        if (moveElement) {\n            e.preventDefault();\n            showMoveSectionPopup(moveElement);\n            return;\n        }\n\n        const moveCmElement = e.target.closest(SELECTORS.CM_MOVE);\n        if (moveCmElement) {\n            e.preventDefault();\n            showMoveCmPopup(moveCmElement);\n            return;\n        }\n    });\n};\n\nconst confirmMerge = (target) => {\n    const href = target.getAttribute('href');\n    getStrings([\n        {key: 'confirm', component: 'moodle'},\n        {key: 'confirmmerge', component: 'format_flexsections'},\n        {key: 'yes', component: 'moodle'},\n        {key: 'no', component: 'moodle'}\n    ]).done(function(strings) {\n        Notification.confirm(\n            strings[0], // Confirm.\n            strings[1], // Are you sure you want to merge.\n            strings[2], // Yes.\n            strings[3], // No.\n            function() {\n                window.location.href = href + '&confirm=1';\n            }\n        );\n    }).fail(Notification.exception);\n};\n\nconst showMoveSectionPopup = (target) => {\n    const reactive = getCurrentCourseEditor();\n    const sectionId = target.getAttribute('data-id');\n    const sectionInfo = reactive.get('section', sectionId);\n    const exporter = reactive.getExporter();\n    const data = exporter.course(reactive.state);\n    data.sectiontitle = sectionInfo.title;\n    //console.log(data);\n\n    if (data.sections.length === 1 && `${data.sections[0].singlesection}` === '1') {\n        // We are on a page of a collapsed section. Do not show \"move before\" and \"move after\" controls.\n        data.singlesectionmode = 1;\n        data.sections[0].contentcollapsed = false;\n        // TODO allow to move from collapsed section up level.\n    }\n    const buildParents = (sections, parents) => {\n        for (var i in sections) {\n            sections[i].parents = parents;\n            sections[i].aftersectionid = (i>0) ? sections[i-1].id : 0;\n            buildParents(sections[i].children, parents + ',' + sections[i].id);\n            sections[i].lastchildid = sections[i].children.length ? sections[i].children[sections[i].children.length - 1].id : 0;\n        }\n    };\n    buildParents(data.sections, '');\n    data.lastchildid = data.sections.length ? data.sections[data.sections.length - 1].id : 0;\n\n    ModalFactory.create({\n        type: ModalFactory.types.CANCEL,\n        title: getString('movecoursesection', 'core'),\n        large: true,\n        buttons: {cancel: getString('closebuttontitle', 'core')},\n        removeOnClose: true,\n    })\n        .then(modal => {\n            Templates.render('format_flexsections/local/content/movesection', data).\n                then((body) => {\n                    modal.setBody(body);\n                    setupMoveSection(reactive, modal, modal.getBody()[0], sectionId, data);\n            });\n            modal.show();\n            return modal;\n        });\n};\n\nconst showMoveCmPopup = (target) => {\n    const cmId = target.dataset.id;\n    if (!cmId) {\n        return;\n    }\n    const reactive = getCurrentCourseEditor();\n    const cmInfo = reactive.get('cm', cmId);\n\n    const exporter = reactive.getExporter();\n    const data = exporter.course(reactive.state);\n\n    // TODO set before and after current as disabled.\n    // TODO allow to move from collapsed section up level.\n\n    data.cmid = cmInfo.id;\n    data.cmname = cmInfo.name;\n\n    ModalFactory.create({\n        type: ModalFactory.types.CANCEL,\n        title: getString('movecoursemodule', 'core'),\n        large: true,\n        buttons: {cancel: getString('closebuttontitle', 'core')},\n        removeOnClose: true,\n    })\n        .then(modal => {\n            Templates.render('format_flexsections/local/content/movecm', data).\n            then((body) => {\n                modal.setBody(body);\n                setupMoveCm(reactive, modal, modal.getBody()[0], cmId, data);\n            });\n            modal.show();\n            return modal;\n        });\n};\n\nconst setupMoveCm = (reactive, modal, modalBody, cmId, data, element = null) => {\n\n    // Capture click.\n    modalBody.addEventListener('click', (event) => {\n        const target = event.target;\n        if (!target.matches('a') || target.dataset.for === undefined || target.dataset.id === undefined) {\n            return;\n        }\n        if (target.getAttribute('aria-disabled')) {\n            return;\n        }\n        event.preventDefault();\n\n        const targetSectionId = (target.dataset.for === 'section') ? target.dataset.id : 0;\n        const targetCmId = (target.dataset.for === 'cm') ? target.dataset.id : 0;\n        reactive.dispatch('cmMove', [cmId], targetSectionId, targetCmId);\n        _destroyModal(modal, element);\n    });\n};\n\nconst _destroyModal = (modal, element = null) => {\n\n    // Destroy\n    modal.hide();\n    const pendingDestroy = new Pending(`courseformat/actions:destroyModal`);\n    if (element) {\n        element.focus();\n    }\n    setTimeout(() =>{\n        modal.destroy();\n        pendingDestroy.resolve();\n    }, 500);\n\n};\n\nconst setupMoveSection = (reactive, modal, modalBody, sectionId, data, element = null) => {\n\n    // Disable moving before or after itself or under one of its own children.\n    const links = modalBody.querySelectorAll(`${SELECTORS.SECTIONLINK}`);\n    for (let i = 0; i < links.length; ++i) {\n        const re = new RegExp(`,${sectionId},`,\"g\");\n        if (links[i].getAttribute('data-id') === `${sectionId}` || links[i].getAttribute('data-after') === `${sectionId}` ||\n            `${links[i].getAttribute('data-parents')},`.match(re)) {\n            _disableLink(links[i]);\n        }\n    }\n\n    // Setup keyboard navigation.\n    // new ContentTree(\n    //     modalBody.querySelector(this.selectors.CONTENTTREE),\n    //     {\n    //         SECTION: this.selectors.SECTIONNODE,\n    //         TOGGLER: this.selectors.MODALTOGGLER,\n    //         COLLAPSE: this.selectors.MODALTOGGLER,\n    //     },\n    //     true\n    // );\n\n    // Capture click.\n    modalBody.addEventListener('click', (event) => {\n\n        const target = event.target;\n        if (!target.matches('a') || target.dataset.for !== 'section' || target.dataset.id === undefined) {\n            return;\n        }\n        if (target.getAttribute('aria-disabled')) {\n            return;\n        }\n        event.preventDefault();\n        reactive.dispatch('sectionMove', [sectionId], target.dataset.id);\n\n        _destroyModal(modal, element);\n    });\n};\n\n/**\n * Disable link\n *\n * @param {Element} element\n */\nconst _disableLink = (element) => {\n    if (element) {\n        element.style.pointerEvents = 'none';\n        element.style.userSelect = 'none';\n        element.classList.add('disabled');\n        element.setAttribute('aria-disabled', true);\n        element.addEventListener('click', event => event.preventDefault());\n    }\n};\n"],"names":["SELECTORS","reactive","getExporter","Exporter","document","addEventListener","e","mergeupElement","target","closest","preventDefault","confirmMerge","moveElement","showMoveSectionPopup","moveCmElement","showMoveCmPopup","href","getAttribute","key","component","done","strings","confirm","window","location","fail","Notification","exception","sectionId","sectionInfo","get","data","course","state","sectiontitle","title","sections","length","singlesection","singlesectionmode","contentcollapsed","buildParents","parents","i","aftersectionid","id","children","lastchildid","create","type","ModalFactory","types","CANCEL","large","buttons","cancel","removeOnClose","then","modal","render","body","setBody","setupMoveSection","getBody","show","cmId","dataset","cmInfo","cmid","cmname","name","setupMoveCm","modalBody","element","event","matches","undefined","for","targetSectionId","targetCmId","dispatch","_destroyModal","hide","pendingDestroy","Pending","focus","setTimeout","destroy","resolve","links","querySelectorAll","re","RegExp","match","_disableLink","style","pointerEvents","userSelect","classList","add","setAttribute"],"mappings":"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"}